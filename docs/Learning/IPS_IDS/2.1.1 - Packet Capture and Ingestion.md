# ğŸ“¥ 2.1.1 â€“ Packet Capture and Ingestion (Explained)

This is the first stage of the IDS/IPS engine pipeline â€” where raw traffic is acquired from the network interfaces before decoding or analysis.

---

## ğŸ”¹ What are Raw Packets?

**Raw packets** refer to network frames or datagrams captured directly from the network interface â€” before any processing by the operating system. This includes the **Ethernet frame**, **IP headers**, **TCP/UDP headers**, and the **payload**.

These packets represent exactly what is seen on the wire, byte-for-byte.

ğŸ” Example:  
A TCP SYN packet from an Nmap scan would be captured in its entirety, including flags, options, and payload if present.

ğŸ“˜ RFC Reference: [RFC 791 â€“ Internet Protocol](https://datatracker.ietf.org/doc/html/rfc791)

---

## ğŸ”¹ Capture Interfaces Used by IDS Engines

IDS/IPS systems like Suricata support several methods for packet capture. Each has different performance characteristics and system requirements.

---

### ğŸ“˜ libpcap

- Most common and portable capture method  
- Used by tools like `tcpdump`, `Wireshark`, and Suricata (`pcap` mode)  
- Operates in **user space**, pulling packets from kernel buffers  
- Uses **BPF filters** to filter incoming traffic  

**References**:

- [libpcap Man Page](https://man7.org/linux/man-pages/man3/pcap.3.html)  
- [libpcap GitHub Repo](https://github.com/the-tcpdump-group/libpcap)  
- ğŸ¥ [Computerphile Video â€“ Packet Sniffers Explained](https://www.youtube.com/watch?v=3QhU9jd03a0)

---

### ğŸ”§ AF_PACKET (Linux-specific)

- High-performance Linux socket for raw packet capture  
- Works in **kernel space**, then delivers to user space  
- Allows use of **ring buffers** for efficient capture (zero-copy with `TPACKET_V3`)  
- Preferred for high-speed environments in Linux  

**References**:

- [AF_PACKET explained (by ntop)](https://www.ntop.org/linux/introducing-afpacket/)  
- [Linux Kernel AF_PACKET Guide](https://www.kernel.org/doc/html/latest/networking/af_packet.html)  
- [pcap vs af_packet vs PF_RING](https://blog.ntop.org/2013/05/15/packet-capture-pcap-vs-af_packet-vs-pf_ring/)

---

### âš™ï¸ Netmap

- Framework for **fast packet I/O** between NIC and user space  
- Bypasses Linux network stack entirely  
- Uses **zero-copy** and direct memory access (DMA)  
- Excellent for IDS/IPS at 10Gbps+ links  

**References**:

- [Netmap Project â€“ Official Site](https://netmap.igel.unn.it/)  
- [Suricata Netmap Mode Docs](https://docs.suricata.io/en/latest/performance/netmap.html)  
- [Netmap â€“ High-Speed Packet I/O (IEEE paper)](https://ieeexplore.ieee.org/document/6232970)

---

### ğŸš€ DPDK (Data Plane Development Kit)

- Set of libraries for **ultra-fast packet processing** in user space  
- Requires compatible NICs and CPU features (e.g., hugepages, UIO)  
- Can handle **40Gbps+ throughput**  
- Often used in **telco** and **high-frequency trading** environments  

**References**:

- [DPDK Official Site](https://www.dpdk.org/)  
- [DPDK and Suricata Integration Guide](https://docs.suricata.io/en/latest/performance/packet-capture.html#dpdk)  
- ğŸ¥ [YouTube â€“ Intro to DPDK](https://www.youtube.com/watch?v=aeedhUJrLZU)

---

## ğŸ§ª Passive vs Inline Modes

| Mode      | Description                              | Use Case                              |
|-----------|------------------------------------------|----------------------------------------|
| **Passive** | Uses mirror port or tap; non-intrusive   | Safe observation, SOC-style monitoring |
| **Inline**  | IDS sits in the traffic path; can block  | Real-time protection, active prevention|

> In passive mode, packets are duplicated and sent to the IDS â€” the IDS cannot alter them. In inline mode, the IDS/IPS acts like a transparent bridge and can **drop, modify or allow** traffic.

ğŸ”— [Suricata IDS vs IPS Overview](https://docs.suricata.io/en/latest/suricata-as-an-ids.html)

---

## ğŸ¯ BPF Filters (Berkeley Packet Filters)

Used to **selectively capture** only specific traffic based on rules like IP, port, protocol, etc.

Example:  
`tcpdump -i eth0 tcp port 80`

- Great for reducing resource usage  
- Used by `libpcap`, `tcpdump`, and Suricata in `pcap` mode

ğŸ”— [BPF Syntax Guide â€“ tcpdump](https://man7.org/linux/man-pages/man7/pcap-filter.7.html)

---

## ğŸŒ Interface Bonding and VLAN Support

- **Bonding** allows multiple NICs to act as a single interface (for redundancy or performance)  
- **VLAN support** enables the IDS to inspect tagged traffic across virtual LANs  
- Important for setups with mirrored trunks or SPAN ports

ğŸ”— [Linux Bonding Documentation](https://www.kernel.org/doc/html/latest/networking/bonding.html)  
ğŸ”— [Suricata VLAN Handling](https://docs.suricata.io/en/latest/configuration/suricata-yaml.html#vlan-use)

---

## ğŸ“¦ Summary

Understanding how raw packet ingestion works is essential to:

- Optimize packet capture for performance  
- Choose the right capture method for your network  
- Troubleshoot packet loss or missed alerts  
- Improve IDS visibility and accuracy

---

## ğŸ”— Further Reading

| Type      | Title / Description                                  | Link                                                                 | Related To               |
|-----------|-------------------------------------------------------|----------------------------------------------------------------------|--------------------------|
| ğŸ“˜ Doc    | Suricata â€“ Packet Capture Options                     | <https://docs.suricata.io/en/latest/performance/packet-capture.html>  | All interfaces           |
| ğŸ¥ Video  | Packet Sniffing Explained (Computerphile)             | <https://www.youtube.com/watch?v=3QhU9jd03a0>                          | libpcap                  |
| ğŸ“˜ Article| AF_PACKET vs pcap vs Netmap â€“ Performance Comparison | <https://blog.ntop.org/2013/05/15/packet-capture-pcap-vs-af_packet-vs-pf_ring/> | AF_PACKET, Netmap        |
| ğŸ“„ Paper  | Netmap â€“ High-Speed Packet I/O                        | <https://ieeexplore.ieee.org/document/6232970>                         | Netmap                   |
| ğŸ“˜ Doc    | BPF Filter Syntax                                     | <https://man7.org/linux/man-pages/man7/pcap-filter.7.html>            | BPF                      |
| ğŸ“˜ Doc    | Suricata VLAN Support                                 | <https://docs.suricata.io/en/latest/configuration/suricata-yaml.html#vlan-use> | VLANs                    |
| ğŸ“˜ Doc    | Linux Bonding Guide                                   | <https://www.kernel.org/doc/html/latest/networking/bonding.html>      | Interface bonding        |
