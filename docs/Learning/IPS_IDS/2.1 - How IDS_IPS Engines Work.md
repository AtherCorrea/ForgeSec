# 🧠 2.1 - How IDS/IPS Engines Work

This document explains how Intrusion Detection and Prevention Systems (IDS/IPS) operate internally — covering traffic inspection architecture, detection pipelines, and how systems like Suricata process and react to packets in real time.

> Although Suricata will be our main tool in the lab, the concepts discussed here apply to most modern IDS/IPS engines.

---

## 🧩 Core Components of an IDS/IPS Engine

Modern IDS/IPS engines rely on a modular architecture to perform high-speed packet analysis and signature matching. Key components include:

### 1. **Packet Capture Layer**

- Captures raw network packets (e.g., via libpcap, AF\_PACKET, or Netmap)
- May be inline (IPS) or passive (IDS)
- Feeds packets into the detection pipeline

### 2. **Decode & Preprocessing Modules**

- Decodes protocol layers (Ethernet, IP, TCP/UDP, HTTP, DNS, etc.)
- Normalizes malformed traffic
- Extracts metadata for further inspection

🔗 [Suricata Packet Decoding – Docs](https://docs.suricata.io/en/latest/performance/packet-capture.html)

### 3. **Flow Engine (State Tracking)**

- Maintains connection state (e.g., TCP sessions)
- Aggregates packets into flows for context-aware analysis
- Enables detection of session-based anomalies

### 4. **Detection Engine**

- Matches traffic against loaded signatures or heuristics
- Handles:
  - Pattern matching (payloads, headers)
  - Keyword operators (`http.user_agent`, `content`, `uricontent`)
  - Rule actions (`alert`, `drop`, `reject`)
- Can apply prioritization (`priority`, `classtype`) for alert relevance

🔗 [Suricata Rule Keywords – OISF Docs](https://docs.suricata.io/en/latest/rules/intro.html)

### 5. **Logging & Output Modules**

- Writes alerts, logs, and metadata
- Common outputs:
  - `eve.json` – JSON-formatted full event log (used by SIEMs)
  - `fast.log` – Classic flat alert log
  - `stats.log` – Engine performance metrics

🔗 [EVE JSON Format – Suricata Docs](https://docs.suricata.io/en/latest/output/eve/eve-json-output.html)

---

## 🔄 IDS Detection Pipeline (Step-by-Step)

Here's how a typical packet is processed inside an IDS engine:

```text
[ Packet Received ]
        ↓
[ Decode Ethernet/IP/TCP layers ]
        ↓
[ Reassemble flow / session context ]
        ↓
[ Apply pre-processors (e.g., HTTP, TLS) ]
        ↓
[ Run detection rules / signatures ]
        ↓
[ If match → generate alert or drop ]
        ↓
[ Output to log files (JSON, syslog, etc.) ]
```

---

## ⚙️ Multithreading and Performance

- Engines like Suricata are designed for **high throughput**
- Uses multi-threaded architecture with:
  - One thread per packet capture interface
  - Detection workers running in parallel
  - Load balancing for performance scaling
- Tuning options:
  - Flow timeout values
  - Detection thread count
  - Memory buffers and packet queues

🔗 [Performance Tuning Guide – Suricata Docs](https://docs.suricata.io/en/latest/performance/intro.html)

---

## 📦 Inline vs Passive Modes (IDS vs IPS)

| Mode        | Description                                         | Use Case                        |
| ----------- | --------------------------------------------------- | ------------------------------- |
| **Passive** | Observes traffic via mirror/SPAN port               | Learning and detection          |
| **Inline**  | Sits between endpoints; can block or reject traffic | Real-time prevention (IPS mode) |

> In our lab, we begin with Passive (IDS) mode to safely study traffic behavior.

---

## 📊 Key Log Files (Suricata)

| Log File    | Description                                           |
| ----------- | ----------------------------------------------------- |
| `eve.json`  | Structured event log (alerts, flows, HTTP, TLS, etc.) |
| `fast.log`  | Flat text alert log                                   |
| `stats.log` | Performance metrics and engine stats                  |

These logs help us:

- Correlate events in SIEM
- Validate test results
- Track performance during attacks

---

## 🧠 Summary

Understanding the internal workings of an IDS/IPS is essential to:

- Build accurate and effective detection rules
- Identify false positives and noisy patterns
- Optimize for performance and low latency
- Properly integrate with SIEM and incident response workflows

In the next section, we’ll explore **how Suricata rules work** in detail — their structure, syntax, and behavior.

📄 Next: [`2.2 - IDS Rule Anatomy and Behavior`](./2.2%20-%20IDS%20Rule%20Anatomy%20and%20Behavior.md)
